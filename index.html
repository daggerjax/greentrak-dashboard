<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0e17">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GreenTrak">
<title>GreenTrak — Portfolio Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--safe-top: env(safe-area-inset-top);--safe-bottom: env(safe-area-inset-bottom);}
body{font-family:'IBM Plex Mono','Fira Code',monospace;background:#0a0e17;color:#e2e8f0;min-height:100vh;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom);}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:#1a1f2e}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pl{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes spin{to{transform:rotate(360deg)}}
.fu{animation:fu .35s ease-out both}
.card{background:#0f1420;border:1px solid #1e293b;border-radius:8px;padding:14px}
.row-h:hover{background:rgba(99,102,241,0.06)!important}
.tb{padding:8px 16px;border:1px solid #1e293b;background:transparent;color:#94a3b8;cursor:pointer;font-size:11px;font-family:inherit;letter-spacing:.5px;text-transform:uppercase;transition:all .2s;border-radius:8px;min-height:34px}
.tb:hover{border-color:#475569;color:#e2e8f0}.tb.a{background:#6366f1;border-color:#6366f1;color:#fff}
.rfb{padding:7px 14px;border:1px solid #1e293b;background:transparent;color:#94a3b8;cursor:pointer;font-size:10px;font-family:inherit;border-radius:8px;transition:all .2s;min-height:34px}
.rfb:hover{border-color:#6366f1;color:#e2e8f0;background:rgba(99,102,241,.08)}
.rfb.loading{pointer-events:none;opacity:.65}
.dm{font-family:'DM Sans',sans-serif}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.lbl{font-size:8px;color:#94a3b8;letter-spacing:1.2px;text-transform:uppercase;margin-bottom:6px}
.big{font-family:'DM Sans',sans-serif;font-size:20px;font-weight:800;letter-spacing:-.4px}
.sub{font-size:10px;margin-top:3px;color:#94a3b8}
.sect{font-size:9px;letter-spacing:1.2px;margin-bottom:10px;font-weight:700}
.pill{padding:2px 7px;border-radius:6px;font-size:10px;font-weight:700;display:inline-block}
.tag{font-size:9px;font-weight:800;color:#06b6d4;background:rgba(6,182,212,0.1);padding:1px 6px;border-radius:6px}
table{width:100%;border-collapse:collapse;font-size:11px}
th{padding:10px 12px;font-size:8px;color:#94a3b8;letter-spacing:1px;font-weight:700;border-bottom:1px solid #1e293b;text-transform:uppercase;cursor:pointer;user-select:none;position:relative;white-space:nowrap}
th:hover{color:#e2e8f0}
th .sort{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:10px;color:#64748b}
td{padding:10px 12px;border-bottom:1px solid #151b2b;white-space:nowrap}
a.news{color:#e2e8f0;text-decoration:none}
a.news:hover{text-decoration:underline}
#loading{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;min-height:100vh;padding:40px}
#loading .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#10b981,#06b6d4);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:#0a0e17;animation:pl 1.5s infinite}
#app{display:none}
#setup{display:none;min-height:100vh;padding:34px 18px;max-width:900px;margin:0 auto}
.spinner{width:14px;height:14px;border:2px solid #1e293b;border-top-color:#6366f1;border-radius:50%;animation:spin .6s linear infinite;display:inline-block;vertical-align:middle;margin-right:6px}
@media(max-width:900px){
  .grid5{grid-template-columns:repeat(2,1fr)}
  .grid2{grid-template-columns:1fr}
  #tabs{position:sticky;top:calc(52px + var(--safe-top));z-index:5;background:rgba(10,14,23,0.78);backdrop-filter: blur(10px);padding:10px 0}
  #tabs .tb{flex:1;text-align:center}
  #tabs{display:flex}
}
</style>
</head>
<body>

<div id="loading">
  <div class="logo">G</div>
  <div style="font-size:14px;color:#94a3b8" id="loadMsg">Loading portfolio from Google Sheets…</div>
  <div style="font-size:10px;color:#475569" id="loadSub">Connecting to live data feed</div>
</div>

<div id="setup">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px">
    <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#10b981,#06b6d4);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:#0a0e17">G</div>
    <div>
      <div class="dm" style="font-weight:900;font-size:18px;color:#f1f5f9;letter-spacing:-.2px">GreenTrak</div>
      <div style="font-size:10px;color:#94a3b8;letter-spacing:1.2px;text-transform:uppercase">Portfolio Intelligence · BYO Sheet</div>
    </div>
  </div>

  <div class="card" style="padding:18px;border-radius:12px">
    <div class="dm" style="font-weight:900;font-size:16px;color:#f1f5f9;margin-bottom:6px">Connect your Google Sheet</div>
    <div style="font-size:11px;color:#94a3b8;line-height:1.6;margin-bottom:14px">
      This dashboard runs in your browser. Your data source URL is stored only in <b>this</b> browser (localStorage).
      Sharing this page is safe — others won’t see your data unless they add their own proxy URL.
    </div>

    <label class="lbl" style="margin:0">Apps Script Proxy URL</label>
    <input id="proxyInput" placeholder="https://script.google.com/macros/s/…/exec"
      style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1e293b;background:#0a0e17;color:#e2e8f0;font-family:inherit;font-size:11px;outline:none;margin-top:8px" />
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px">
      <button class="tb a" onclick="saveProxyFromSetup()">Save & Load</button>
    </div>

    <div style="margin-top:16px;border-top:1px solid #151b2b;padding-top:14px">
      <div class="dm" style="font-weight:800;color:#cbd5e1;margin-bottom:6px">Need a proxy?</div>
      <div style="font-size:11px;color:#94a3b8;line-height:1.6">
        Create a Google Apps Script web app that returns your <b>Holdings</b> tab as TSV/CSV.
        Then paste the deployed web app URL above.
      </div>
    </div>
  </div>

  <div style="text-align:center;padding:18px 0 6px;font-size:9px;color:#475569;margin-top:18px">
    GreenTrak Portfolio Intelligence · Local-only settings · No server
  </div>
</div>

<div id="app">
  <div style="border-bottom:1px solid #1e293b;padding:14px 24px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#0f1420,#0a0e17);flex-wrap:wrap;gap:10px">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="width:30px;height:30px;border-radius:10px;background:linear-gradient(135deg,#10b981,#06b6d4);display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:900;color:#0a0e17">G</div>
      <div>
        <div class="dm" style="font-weight:900;font-size:16px;color:#f1f5f9">GreenTrak</div>
        <div style="font-size:8px;color:#94a3b8;letter-spacing:1.5px;text-transform:uppercase">Portfolio Intelligence · Live from Google Sheets</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <button class="rfb" id="refreshBtn" onclick="fetchData()">↻ Refresh</button>
      <button class="rfb" onclick="openSettings()" title="Settings">⚙</button>
      <div style="text-align:right">
        <div id="dateStr" style="font-size:11px;color:#94a3b8"></div>
        <div style="display:flex;align-items:center;gap:5px;justify-content:flex-end;margin-top:2px">
          <div id="statusDot" style="width:6px;height:6px;border-radius:50%;background:#10b981;animation:pl 2s infinite"></div>
          <span id="statusStr" style="font-size:9px;color:#94a3b8"></span>
        </div>
      </div>
    </div>
  </div>

  <div id="mainWrap" style="padding:16px 24px;max-width:1400px;margin:0 auto">
    <div id="summary" class="grid5 fu" style="margin-bottom:16px"></div>
    <div id="benchmarks" class="fu" style="margin-bottom:16px"></div>
    <div id="vsBar" class="card fu" style="margin-bottom:16px;padding:8px 14px;display:flex;align-items:center;gap:20px;font-size:10px;flex-wrap:wrap"></div>

    <div id="tabs" style="display:flex;gap:6px;margin-bottom:16px">
      <button class="tb a" onclick="switchTab('overview')">Overview</button>
      <button class="tb" onclick="switchTab('holdings')">Holdings</button>
    </div>

    <div id="tab-overview" class="grid2 fu"></div>
    <div id="tab-holdings" class="fu" style="display:none"></div>

    <div style="text-align:center;padding:20px 0 8px;font-size:9px;color:#475569;border-top:1px solid #151b2b;margin-top:20px">
      GreenTrak Portfolio Intelligence · Live via GOOGLEFINANCE()
      <br><span style="color:#64748b">Continuing the vision from 1993 — consolidated, unbiased investment reporting</span>
    </div>
  </div>
</div>

<div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:200;align-items:center;justify-content:center;padding:22px">
  <div class="card" style="max-width:760px;width:100%;border-radius:14px;padding:16px 16px 14px;background:#0f1420">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <div class="dm" style="font-weight:900;font-size:15px;color:#f1f5f9">Settings</div>
      <button class="rfb" onclick="closeSettings()">Close</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr;gap:10px">
      <div>
        <div class="lbl">Apps Script Proxy URL</div>
        <input id="settingsProxy" placeholder="https://script.google.com/macros/s/…/exec"
          style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid #1e293b;background:#0a0e17;color:#e2e8f0;font-family:inherit;font-size:11px;outline:none" />
        <div style="font-size:10px;color:#64748b;margin-top:6px;line-height:1.5">Stored only in this browser.</div>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;margin-top:6px">
        <div style="min-width:240px;flex:1">
          <div class="lbl">Auto-refresh</div>
          <select id="settingsRefresh" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid #1e293b;background:#0a0e17;color:#e2e8f0;font-family:inherit;font-size:11px;outline:none">
            <option value="30">30 seconds</option>
            <option value="60">60 seconds</option>
            <option value="120">2 minutes</option>
            <option value="300">5 minutes</option>
          </select>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="rfb" onclick="testConnection()">Test</button>
          <button class="rfb" onclick="resetAll()" title="Clears local settings">Reset</button>
          <button class="tb a" onclick="saveSettings()">Save</button>
        </div>
      </div>

      <div id="testResult" style="display:none;margin-top:8px;padding:10px 12px;border-radius:12px;border:1px solid #1e293b;background:#0a0e17;color:#cbd5e1;font-size:11px;line-height:1.5"></div>
    </div>
  </div>
</div>

<script>
/* ----------------- local settings ----------------- */
const LS_PROXY_KEY="greentrak_proxy_url";
const LS_REFRESH_KEY="greentrak_refresh_sec";
const DEFAULT_REFRESH_SEC=60;

let PROXY_URL = (localStorage.getItem(LS_PROXY_KEY)||"").trim();
let REFRESH_SEC = parseInt(localStorage.getItem(LS_REFRESH_KEY)||String(DEFAULT_REFRESH_SEC),10);
if(!Number.isFinite(REFRESH_SEC) || REFRESH_SEC<10) REFRESH_SEC=DEFAULT_REFRESH_SEC;

let DATA=null, currentTab='overview', countdown=REFRESH_SEC, timerInterval=null;

/* Holdings sort */
let sortKey='absValue', sortDir='desc';

/* ----------------- helpers ----------------- */
function pn(s){
  if(s===undefined||s===null)return null;
  const str=String(s).trim();
  if(!str||str==='#N/A'||str==='N/A'||str==='false'||str==='-')return null;
  const parenNeg=str.startsWith('(')&&str.endsWith(')');
  const cleaned=str.replace(/[$,%()]/g,'').replace(/,/g,'').trim();
  const n=parseFloat(cleaned);
  return isNaN(n)?null:(parenNeg?-Math.abs(n):n);
}
function csvSplit(line){
  const r=[];let c='',q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"')q=!q;
    else if(ch===','&&!q){r.push(c.trim().replace(/^"|"$/g,''));c='';}
    else c+=ch;
  }
  r.push(c.trim().replace(/^"|"$/g,''));
  return r;
}
function normHeader(h){
  return String(h||'').trim().toLowerCase()
    .replace(/\s+/g,' ')
    .replace(/[%]/g,'%')
    .replace(/[^\w %$]/g,'');
}
function idxOf(headers, candidates){
  for(const c of candidates){
    const i=headers.indexOf(c);
    if(i>=0) return i;
  }
  return -1;
}

/* Parse TSV/CSV using header names so adding a Name column doesn't break */
function parseData(text){
  const lines = (text||'').split(/
?
/).filter(l=>l.trim());
  if(lines.length<2) return {positions:[], recap:{}, benchmarks:[]};

  const firstLine = lines[0]||'';
  const isCSV = firstLine.includes('"') || (firstLine.split(',').length > firstLine.split('	').length);

  const splitRow = (line)=>{
    if(isCSV) return csvSplit(line);
    return line.split('	').map(c=>String(c).trim().replace(/^"|"$/g,''));
  };

  const header = splitRow(lines[0]).map(h=>String(h||'').trim());
  const hnorm = header.map(h=>String(h||'').trim().toLowerCase());

  const idxOfAny = (cands)=>{
    for(const c of cands){
      const t = String(c).toLowerCase();
      const i = hnorm.indexOf(t);
      if(i>=0) return i;
    }
    // partial contains match
    for(const c of cands){
      const t = String(c).toLowerCase();
      const i = hnorm.findIndex(h=>h.includes(t));
      if(i>=0) return i;
    }
    return -1;
  };

  const iStock = idxOfAny(['stock','ticker','symbol']);
  const iName  = idxOfAny(['name','company']);
  const iQty   = idxOfAny(['qty','quantity','shares']);
  const iYest  = idxOfAny(['yest','yesterday','yest price']);
  const iToday = idxOfAny(['today','today price','last','price']);
  const iValue = idxOfAny(['value','market value']);

  // Two % columns: portfolio weight then daily % change
  const pctIdx = hnorm.map((h,i)=>h==='%'?i:-1).filter(i=>i>=0);
  const iPortPct = pctIdx.length>=1 ? pctIdx[0] : idxOfAny(['% of portfolio','weight']);
  const iDayPct  = pctIdx.length>=2 ? pctIdx[1] : idxOfAny(['% g/l','% gl','day %','chg %','% change']);

  // One $ column for daily $ P&L
  const iDayDollar = hnorm.findIndex(h=>h==='$')>=0 ? hnorm.findIndex(h=>h==='$') : idxOfAny(['$ g/l','day $','p&l','pl','$']);

  // Per-share change column
  let iPerShare = idxOfAny(['share price g/l','per share','chg','change','g/l']);
  // Avoid accidentally picking the $ or % columns
  if(iPerShare===iDayDollar || iPerShare===iPortPct || iPerShare===iDayPct) iPerShare = -1;
  if(iPerShare<0){
    // Often the last column is per-share
    iPerShare = Math.max(iValue, iDayDollar, iDayPct, iToday, iYest, iQty) + 1;
  }

  const positions = [];
  const recap = {};
  const benchmarks = [];

  // Scan all rows for recap + benchmarks while parsing positions until we hit non-position section
  for(let li=1; li<lines.length; li++){
    const r = splitRow(lines[li]);
    if(!r || r.length===0) continue;

    // Recap labels can live anywhere (often col M with value next col N)
    for(let j=0; j<r.length; j++){
      const cell = String(r[j]||'').trim();
      if(!cell) continue;
      const nxt = (j+1<r.length)?String(r[j+1]||'').trim():'';
      if(cell==='TOTAL $') recap.totalDollar = pn(nxt);
      if(cell==='TOTAL %') recap.totalPct = pn(nxt);
      if(cell==='TOTAL VAL=') recap.totalVal = pn(nxt);
      if(cell==='$50K+'||cell==='$50K') recap.over50k = pn(nxt);
      if(cell==='$100K+'||cell==='$100K') recap.over100k = pn(nxt);
      if(cell==='$125K+'||cell==='$125K') recap.over125k = pn(nxt);
      if(cell==='$200K+'||cell==='$200K') recap.over200k = pn(nxt);
      if(cell==='$250K+'||cell==='$250K') recap.over250k = pn(nxt);
    }

    // Benchmarks: typically a block with Name, Today, Yesterday, Change, %, Vs
    const bname = String(r[11]||'').trim(); // col L (0-based 11) in your layout
    if(['NASDAQ','DJII','DJIA','S&P 500','Russell 2k','Russell 2000'].includes(bname)){
      const name = (bname==='DJII') ? 'DJIA' : (bname==='Russell 2000' ? 'Russell 2k' : bname);
      const today = pn(r[12]);      // col M
      const yest  = pn(r[13]);      // col N
      const ch    = pn(r[14]);      // col O
      const pct   = pn(r[15]);      // col P
      const vs    = pn(r[16]);      // col Q
      benchmarks.push({name, today, yest, ch, pct, vs});
    }

    // Stop parsing positions if we hit the benchmark header row or other section
    const firstCell = String(r[iStock>=0?iStock:0]||'').trim();
    if(firstCell.toLowerCase()==='today' || firstCell.toLowerCase()==='nasdaq') continue;

    if(iStock<0 || iQty<0) continue;

    const sym = String(r[iStock]||'').trim();
    if(!sym) continue;

    // Guard against rows like "Today  Yesterday ..."
    if(sym.toLowerCase()==='stock') continue;

    const qty = pn(r[iQty]);
    if(qty===null || qty===0) continue;

    const price = (iToday>=0)?pn(r[iToday]):null;
    const value = (iValue>=0)?pn(r[iValue]):null;

    // Daily P&L dollars and % columns
    const dollarGL = (iDayDollar>=0)?(pn(r[iDayDollar])||0):0;
    const pctGL = (iDayPct>=0)?pn(r[iDayPct]):null;

    // per share change (optional)
    const perShareGL = (iPerShare>=0 && iPerShare<r.length)?pn(r[iPerShare]):null;

    positions.push({
      symbol:sym,
      name: (iName>=0)?String(r[iName]||'').trim():'',
      qty,
      price,
      value,
      dollarGL,
      pctGL,
      perShareGL,
      hasData: price!==null
    });
  }

  // Normalize recap % if it's entered as -0.0216 instead of -2.16
  if(recap.totalPct!==undefined && recap.totalPct!==null && Math.abs(recap.totalPct)<0.5){
    recap.totalPct = recap.totalPct*100;
  }

  return {positions, recap, benchmarks};
}

/* formatters */
const gc=v=>v>0?'#10b981':v<0?'#ef4444':'#94a3b8';
const gbg=v=>v>0?'rgba(16,185,129,0.10)':v<0?'rgba(239,68,68,0.10)':'rgba(148,163,184,0.08)';
const fmt=n=>{if(n===null||isNaN(n))return'—';const a=Math.abs(n),s=n<0?'-':'';if(a>=1e6)return s+'$'+(a/1e6).toFixed(2)+'M';if(a>=1e3)return s+'$'+(a/1e3).toFixed(1)+'K';return s+'$'+a.toFixed(2);};
const fmtD=n=>{if(n===null||isNaN(n))return'—';return(n<0?'-$':'$')+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});};
const fmtP=n=>{if(n===null||isNaN(n))return'—';return(n>=0?'+':'')+n.toFixed(2)+'%';};
const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* ----------------- settings UI ----------------- */
function showSetup(){
  document.getElementById('loading').style.display='none';
  document.getElementById('app').style.display='none';
  document.getElementById('setup').style.display='block';
  const inp=document.getElementById('proxyInput');
  if(inp) inp.value = PROXY_URL || '';
}
function saveProxyFromSetup(){
  const v=(document.getElementById('proxyInput').value||'').trim();
  if(!v) return alert('Paste your Apps Script proxy URL first.');
  PROXY_URL=v;
  localStorage.setItem(LS_PROXY_KEY, PROXY_URL);
  if(!localStorage.getItem(LS_REFRESH_KEY)) localStorage.setItem(LS_REFRESH_KEY, String(REFRESH_SEC));
  document.getElementById('setup').style.display='none';
  document.getElementById('loading').style.display='flex';
  fetchData(); startTimer();
}
function openSettings(){
  document.getElementById('testResult').style.display='none';
  document.getElementById('settingsProxy').value = PROXY_URL || '';
  document.getElementById('settingsRefresh').value = String(REFRESH_SEC);
  document.getElementById('settingsModal').style.display='flex';
}
function closeSettings(){ document.getElementById('settingsModal').style.display='none'; }
function saveSettings(){
  const proxy=(document.getElementById('settingsProxy').value||'').trim();
  const refresh=parseInt(document.getElementById('settingsRefresh').value,10);
  if(!proxy) return alert('Proxy URL is required.');
  PROXY_URL=proxy;
  REFRESH_SEC=Number.isFinite(refresh)?refresh:DEFAULT_REFRESH_SEC;
  countdown=REFRESH_SEC;
  localStorage.setItem(LS_PROXY_KEY, PROXY_URL);
  localStorage.setItem(LS_REFRESH_KEY, String(REFRESH_SEC));
  closeSettings();
  fetchData(); startTimer();
}
async function testConnection(){
  const box=document.getElementById('testResult');
  box.style.display='block';
  box.textContent='Testing…';
  const proxy=(document.getElementById('settingsProxy').value||'').trim() || PROXY_URL;
  if(!proxy){ box.textContent='Missing proxy URL.'; return; }
  const t0=performance.now();
  try{
    const res=await fetch(proxy, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=await res.text();
    const parsed=parseData(text);
    const ms=Math.round(performance.now()-t0);
    box.innerHTML = '<b style="color:#10b981">OK</b> · '+ms+'ms · '+parsed.positions.length+' positions';
  }catch(e){
    box.innerHTML = '<b style="color:#ef4444">Failed</b> · '+esc(e.message||String(e));
  }
}
function resetAll(){
  if(!confirm('Reset settings on this device?')) return;
  localStorage.removeItem(LS_PROXY_KEY);
  localStorage.removeItem(LS_REFRESH_KEY);
  PROXY_URL=''; REFRESH_SEC=DEFAULT_REFRESH_SEC; countdown=REFRESH_SEC;
  closeSettings();
  DATA=null;
  showSetup();
}

/* ----------------- fetch + timer ----------------- */
async function fetchData(){
  if(!PROXY_URL){ showSetup(); return; }

  const btn=document.getElementById('refreshBtn');
  btn.innerHTML='<span class="spinner"></span>Fetching...';btn.classList.add('loading');

  try{
    const res=await fetch(PROXY_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=await res.text();
    if(!text || text.length<20) throw new Error('Empty response');
    const parsed = parseData(text);
    DATA = parsed;

    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('statusDot').style.background='#10b981';

    render();
    countdown=REFRESH_SEC;
  }catch(e){
    console.error(e);
    document.getElementById('statusDot').style.background='#ef4444';
    // show a useful error on loading screen if app isn't up yet
    if(!DATA){
      document.getElementById('loadMsg').textContent='Error: '+(e.message||String(e));
      document.getElementById('loadSub').innerHTML='Check your proxy URL, then <button class="rfb" onclick="fetchData()" style="margin-left:8px">Retry</button> or <button class="rfb" onclick="showSetup()" style="margin-left:8px">Setup</button>';
    } else {
      const st=document.getElementById('statusStr');
      if(st) st.textContent='Refresh failed · Retry soon';
    }
  }finally{
    btn.textContent='↻ Refresh';btn.classList.remove('loading');
  }
}
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    countdown--;
    const st=document.getElementById('statusStr');
    if(st && DATA) st.textContent='LIVE · Next refresh: '+countdown+'s';
    if(countdown<=0) fetchData();
  },1000);
}
function switchTab(t){
  currentTab=t;
  document.querySelectorAll('#tabs .tb').forEach(b=>b.classList.toggle('a',b.textContent.toLowerCase()===t));
  ['overview','holdings'].forEach(id=>{document.getElementById('tab-'+id).style.display=id===t?'':'none';});
  if(t==='holdings') renderHoldings();
}

/* ----------------- render ----------------- */
function render(){
  if(!DATA) return;

  const positions = DATA.positions || [];
  const longs = positions.filter(p=>p.qty>0);
  const shorts = positions.filter(p=>p.qty<0);
  const ll = longs.filter(p=>p.hasData);
  const sl = shorts.filter(p=>p.hasData);

  const totVal = ll.reduce((s,p)=>s+(p.value||0),0); // long value only
  const totShort = sl.reduce((s,p)=>s+(p.value||0),0); // negative

  const totGL = positions.reduce((s,p)=>s+(p.dollarGL||0),0);
  const totPct = (totVal>0)?(totGL/totVal*100):0;

  const now=new Date();
  document.getElementById('dateStr').textContent=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('statusStr').textContent='LIVE · Updated '+now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'})+' · Next: '+countdown+'s';

  // counts for Positions card
  const over50 = ll.filter(p=>(p.value||0)>=50000).length;
  const over100 = ll.filter(p=>(p.value||0)>=100000).length;
  const over250 = ll.filter(p=>(p.value||0)>=250000).length;

  // top 10 concentration
  const top10Conc = totVal>0 ? ( [...ll].sort((a,b)=>(b.value||0)-(a.value||0)).slice(0,10).reduce((s,p)=>s+(p.value||0),0) / totVal * 100 ) : null;

  // Summary cards order: VALUE, P&L, POSITIONS, TOP10 CONC, LIVE QUOTES
  const cards=[
    {l:'PORTFOLIO VALUE',v:fmtD(totVal),sub:longs.length+'L / '+shorts.length+'S positions',c:''},
    {l:"TODAY'S P&L",v:fmtD(totGL),sub:fmtP(totPct),c:gc(totGL)},
    {l:'POSITIONS',v:String(positions.length),sub:`$50K+: ${over50} · $100K+: ${over100} · $250K+: ${over250}`,c:''},
    {l:'TOP 10 CONC.',v:(top10Conc===null?'—':top10Conc.toFixed(0)+'%'),sub:'of long portfolio',c:''},
    {l:'LIVE QUOTES',v:(ll.length+sl.length)+'/'+positions.length,sub:(positions.length-ll.length-sl.length)+' unavailable',c:''},
  ];
  document.getElementById('summary').innerHTML=cards.map(c=>`<div class="card"><div class="lbl">${c.l}</div><div class="big" style="color:${c.c||'#f1f5f9'}">${c.v}</div><div class="sub" style="color:${c.c||'#94a3b8'}">${c.sub}</div></div>`).join('');

  // Benchmarks are not in proxy response in this header-based version; keep hidden for now
  document.getElementById('benchmarks').style.display='none';
  document.getElementById('vsBar').style.display='none';

  // Lists
  const topG=[...ll].sort((a,b)=>(b.dollarGL||0)-(a.dollarGL||0)).slice(0,5);
  const topL=[...ll].sort((a,b)=>(a.dollarGL||0)-(b.dollarGL||0)).slice(0,5);
  const top10=[...ll].sort((a,b)=>(b.value||0)-(a.value||0)).slice(0,10);
  const top10S=[...sl].sort((a,b)=>(a.value||0)-(b.value||0)).slice(0,10); // most negative first

  const mkList=(items,color)=>items.map((p,i)=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;${i<4?'border-bottom:1px solid #1a1f2e':''}">
      <div style="display:flex;align-items:center;gap:8px;min-width:0">
        <span style="font-size:9px;color:#94a3b8;width:14px">${i+1}</span>
        <span style="font-weight:800;font-size:12px;color:#f1f5f9">${esc(p.symbol)}</span>
        <span style="font-size:9px;color:#cbd5e1">${Math.abs(p.qty).toLocaleString()}sh</span>
      </div>
      <div style="text-align:right">
        <span style="font-size:12px;font-weight:800;color:${color}">${fmt(p.dollarGL)}</span>
        <span style="font-size:10px;color:${color};margin-left:6px;font-weight:700">${p.pctGL!==null?fmtP(p.pctGL):''}</span>
      </div>
    </div>`).join('');

  // Top 10 holdings table-like list with two extra columns: Day $ and Day %
  const mkTop=top10.map((p,i)=>{
    const pct=totVal>0?((p.value||0)/totVal*100):0;
    const nm = p.name ? ` <span style="color:#94a3b8;font-weight:700">· ${esc(p.name)}</span>` : '';
    return `
    <div style="display:flex;align-items:center;gap:10px;padding:7px 0;${i<9?'border-bottom:1px solid #1a1f2e':''}">
      <span style="font-size:9px;color:#94a3b8;width:14px">${i+1}</span>
      <div style="min-width:180px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
        <span style="font-weight:900;font-size:11px;color:#f1f5f9">${esc(p.symbol)}</span>${nm}
      </div>
      <span style="font-size:10px;color:#cbd5e1;width:74px;text-align:right">${fmt(p.value)}</span>
      <span style="font-size:10px;color:#cbd5e1;font-weight:800;width:52px;text-align:right">${pct.toFixed(1)}%</span>
      <span style="font-size:10px;color:${gc(p.dollarGL)};font-weight:800;width:74px;text-align:right">${fmt(p.dollarGL)}</span>
      <span style="font-size:10px;color:${gc(p.pctGL||0)};font-weight:800;width:56px;text-align:right">${p.pctGL!==null?fmtP(p.pctGL):'—'}</span>
    </div>`;
  }).join('');

  // Shorts list with % of portfolio (totVal) and day columns
  const mkS=top10S.length===0
    ? '<div style="color:#64748b;font-size:11px">No live short data</div>'
    : top10S.map((p,i)=>{
      const pctPort = totVal>0 ? ((Math.abs(p.value)||0)/totVal*100) : 0;
      const nm = p.name ? ` <span style="color:#94a3b8;font-weight:700">· ${esc(p.name)}</span>` : '';
      return `
      <div style="display:flex;align-items:center;gap:10px;padding:7px 0;${i<9?'border-bottom:1px solid #1a1f2e':''}">
        <span style="font-size:9px;color:#94a3b8;width:14px">${i+1}</span>
        <div style="min-width:180px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
          <span style="font-weight:900;font-size:11px;color:#f1f5f9">${esc(p.symbol)}</span>${nm}
        </div>
        <span style="font-size:10px;color:#cbd5e1;width:74px;text-align:right">${fmt(p.value)}</span>
        <span style="font-size:10px;color:#cbd5e1;font-weight:800;width:52px;text-align:right">${pctPort.toFixed(1)}%</span>
        <span style="font-size:10px;color:${gc(p.dollarGL)};font-weight:800;width:74px;text-align:right">${fmt(p.dollarGL)}</span>
        <span style="font-size:10px;color:${gc(p.pctGL||0)};font-weight:800;width:56px;text-align:right">${p.pctGL!==null?fmtP(p.pctGL):'—'}</span>
      </div>`;
    }).join('');

  const top10ShortExposure = top10S.reduce((s,p)=>s+Math.abs(p.value||0),0);

  document.getElementById('tab-overview').innerHTML=`
    <div class="card"><div class="sect" style="color:#10b981">▲ TOP GAINERS TODAY</div>${mkList(topG,'#10b981')}</div>
    <div class="card"><div class="sect" style="color:#ef4444">▼ TOP LOSERS TODAY</div>${mkList(topL,'#ef4444')}</div>
    <div class="card"><div class="sect" style="color:#6366f1">TOP 10 HOLDINGS BY VALUE</div>
      <div style="display:flex;gap:10px;padding:6px 0 8px;color:#94a3b8;font-size:8px;letter-spacing:1px;text-transform:uppercase">
        <div style="flex:1;min-width:180px">Symbol / Name</div>
        <div style="width:74px;text-align:right">Value</div>
        <div style="width:52px;text-align:right">% Port</div>
        <div style="width:74px;text-align:right">Day $</div>
        <div style="width:56px;text-align:right">Day %</div>
      </div>
      ${mkTop}
    </div>
    <div class="card"><div class="sect" style="color:#f87171">TOP 10 SHORT POSITIONS</div>
      <div style="display:flex;gap:10px;padding:6px 0 8px;color:#94a3b8;font-size:8px;letter-spacing:1px;text-transform:uppercase">
        <div style="flex:1;min-width:180px">Symbol / Name</div>
        <div style="width:74px;text-align:right">Value</div>
        <div style="width:52px;text-align:right">% Port</div>
        <div style="width:74px;text-align:right">Day $</div>
        <div style="width:56px;text-align:right">Day %</div>
      </div>
      ${mkS}
      <div style="margin-top:10px;padding:8px 10px;background:#0d1119;border-radius:10px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font-size:10px">
        <span style="color:#94a3b8">Total Short Exposure</span>
        <span style="color:#f87171;font-weight:900">${fmtD(totShort)}</span>
        <span style="color:#94a3b8">Top 10 Exposure</span>
        <span style="color:#cbd5e1;font-weight:900">${fmtD(-top10ShortExposure)}</span>
        <span style="color:#94a3b8">${totVal>0?((top10ShortExposure/totVal)*100).toFixed(1):'—'}%</span>
      </div>
    </div>
    <div class="card"><div class="sect" style="color:#64748b">NEWS</div>
      <div style="color:#94a3b8;font-size:11px;line-height:1.5">
        News is currently static in this build (by request). Next step: we’ll wire dynamic market + portfolio news.
      </div>
    </div>
  `;

  if(currentTab==='holdings') renderHoldings();
}

/* holdings sorting */
function toggleSort(key){
  if(sortKey===key){ sortDir = (sortDir==='desc')?'asc':'desc'; }
  else { sortKey=key; sortDir=(key==='symbol')?'asc':'desc'; }
  renderHoldings();
}
function sortValue(p,key){
  const v=x=>(x===null||x===undefined||Number.isNaN(x))?null:x;
  if(key==='symbol')return (p.symbol||'');
  if(key==='name')return (p.name||'');
  if(key==='qty')return v(p.qty);
  if(key==='price')return v(p.price);
  if(key==='chg$')return v(p.perShareGL);
  if(key==='chg%')return v(p.pctGL);
  if(key==='value')return v(p.value);
  if(key==='absValue')return v(Math.abs(p.value||0));
  if(key==='daygl')return v(p.dollarGL);
  return v(p.value);
}
function renderHoldings(){
  if(!DATA) return;
  const all=[...DATA.positions];
  const key=sortKey||'absValue';
  const dir=sortDir||'desc';

  all.sort((a,b)=>{
    const va=sortValue(a,key), vb=sortValue(b,key);
    if(typeof va==='string' || typeof vb==='string'){
      const sa=String(va??'').toUpperCase(), sb=String(vb??'').toUpperCase();
      if(sa<sb) return dir==='asc'?-1:1;
      if(sa>sb) return dir==='asc'?1:-1;
      return 0;
    }
    if(va===null&&vb===null) return 0;
    if(va===null) return 1;
    if(vb===null) return -1;
    if(va<vb) return dir==='asc'?-1:1;
    if(va>vb) return dir==='asc'?1:-1;
    return 0;
  });

  const sortGlyph=k=>(sortKey===k)?(sortDir==='asc'?'▲':'▼'):'';

  const rows=all.map(p=>{
    const v = (p.value!==null && p.qty<0 && p.value>0) ? -Math.abs(p.value) : p.value;
    return `<tr class="row-h" style="opacity:${p.hasData?1:0.35}">
      <td style="font-weight:900;color:#f1f5f9">${esc(p.symbol)}${p.name?`<span style="color:#94a3b8;font-weight:700"> · ${esc(p.name)}</span>`:''}${!p.hasData?'<span style="font-size:8px;color:#64748b;margin-left:6px">N/A</span>':''}</td>
      <td style="text-align:right;color:${p.qty<0?'#f87171':'#f1f5f9'};font-weight:800">${p.qty.toLocaleString()}</td>
      <td style="text-align:right;color:#e2e8f0">${p.price!==null?'$'+p.price.toFixed(2):'—'}</td>
      <td style="text-align:right;color:${gc(p.perShareGL||0)};font-weight:800">${p.perShareGL!==null?(p.perShareGL>=0?'+':'')+p.perShareGL.toFixed(2):'—'}</td>
      <td style="text-align:right"><span class="pill" style="color:${gc(p.pctGL||0)};background:${gbg(p.pctGL||0)}">${p.pctGL!==null?fmtP(p.pctGL):'—'}</span></td>
      <td style="text-align:right;color:#e2e8f0;font-weight:800">${v!==null?fmt(v):'—'}</td>
      <td style="text-align:right;color:${gc(p.dollarGL||0)};font-weight:900">${fmt(p.dollarGL)}</td>
    </tr>`;
  }).join('');

  document.getElementById('tab-holdings').innerHTML=`
    <div style="margin-bottom:10px;font-size:10px;color:#94a3b8">All ${all.length} positions · Click headers to sort</div>
    <div class="card" style="overflow:hidden;padding:0">
      <div style="overflow:auto;max-height:650px">
        <table>
          <thead>
            <tr style="position:sticky;top:0;background:#0f1420;z-index:2">
              <th style="text-align:left" onclick="toggleSort('symbol')">SYMBOL <span class="sort">${sortGlyph('symbol')}</span></th>
              <th style="text-align:right" onclick="toggleSort('qty')">QTY <span class="sort">${sortGlyph('qty')}</span></th>
              <th style="text-align:right" onclick="toggleSort('price')">PRICE <span class="sort">${sortGlyph('price')}</span></th>
              <th style="text-align:right" onclick="toggleSort('chg$')">CHG $ <span class="sort">${sortGlyph('chg$')}</span></th>
              <th style="text-align:right" onclick="toggleSort('chg%')">CHG % <span class="sort">${sortGlyph('chg%')}</span></th>
              <th style="text-align:right" onclick="toggleSort('value')">VALUE <span class="sort">${sortGlyph('value')}</span></th>
              <th style="text-align:right" onclick="toggleSort('daygl')">DAY G/L <span class="sort">${sortGlyph('daygl')}</span></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
}

/* boot */
if(!PROXY_URL){
  showSetup();
} else {
  fetchData();
  startTimer();
}
</script>
</body>
</html>
